version: v1.0
name: Continuous Integration Pipeline
agent:
  machine:
    type: s1-kubernetes
    os_image: ''
  containers:
    - name: main
      image: 'registry.semaphoreci.com/python:3.12.1'
      user: root
fail_fast:
  stop:
    when: branch != 'master'
auto_cancel:
  running:
    when: branch != 'master'
  queued:
    when: branch = 'master'
global_job_config:
  prologue:
    commands:
      - checkout
blocks:
  - name: TDD Tests
    dependencies: []
    task:
      jobs:
        - name: TDD
          commands:
            - cd 1-tdd
            - python test_factorial.py
  - name: Unit tests
    dependencies:
      - TDD Tests
    task:
      jobs:
        - name: Units
          commands:
            - cd 2-unit-testing
            - python test_math_sum.py
  - name: Integration tests
    dependencies:
      - Unit tests
    task:
      jobs:
        - name: Integration
          commands:
            - cd 3-integration-testing
            - python test_integration.py
  - name: End-to-end tests
    dependencies:
      - Integration tests
    task:
      jobs:
        - name: E2E
          commands:
            - cd 4-e2e
            - pip install -r requirements.txt
            - nohup python app.py &
            - sleep 1
            - python test_e2e.py
  - name: Test reports
    dependencies:
      - End-to-end tests
    task:
      jobs:
        - name: Tests
          commands:
            - cd 5-test-reports
            - pip install -r requirements.txt
            - pytest -junitxml=reports.xml
            - '[[ -f report.xml ]] && test-results publish report.xml'
after_pipeline:
  task:
    jobs:
      - name: Generate test reports
        commands:
          - test-results gen-pipeline-report
